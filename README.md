# Tookits for An Iterative Weighting Method to Apply the ISR Correction
Maybe you have noticed that a new method for ISR iteration has been proposed by Liangliang Wang(llwang@ihep.ac.cn) and Wenyu Sun(sunwenyu@ihep.ac.cn) (the theory of the method could be seen in doc/Introduction.pdf), recently. After the check of Tong Liu(liutong2016@ihep.ac.cn) (MC generation example could be seen in example/), this method has been proved to be correct and very time saving. This repository provide a relative general package for user to use the method to do ISR iteration. 

## Install

> cd [Your Work Directory]

> git clone https://github.com/zhixing1996/weighted_isr.git

## Setup

ROOT Version: 5.34/09 or later

Python Version: 2.7.3, should not be python3.x

## Execute

> cd [Your Work Directory]

> python main.py

## Structure of this Repository

> weight_isr.conf: configure file, user changes will mostly happen in here

1. [patch]: patch info, mainly used to create plots name and files name. 
    1. label: a very simple description of the cross sections you put;
    2. iter_old: description of the patch of iteration right now;
    3. iter_new: description of the patch of next iteration.

2. [path]: path info of input cross sections and ouput cross section as well as initial isr factor.
    1. xs_old: input cross sections info;
    2. xs_new: output cross sections info;
    3. ini_isr: initial isr factors generated by scripts like example/ (referred as INI).

3. [draw]: xtitles and ytitles of output plots.
    1. xtitle
    2. xs_ytitle: ytitle of cross section plots;
    3. eff_ytitle: ytitle of isr factors times relative efficiencies.

3. [weight]: necessary info for weighting mc and new cross sections calculation.
    1. shape_dep: True/true or False/false: whether the fitting concerning number of events (referred as FIT_EVT) is mc shape dependent or not;
    2. root_path: root path of INI root files;
    3. event_root: name of root files after selection, should be put in the path under root_path;
    4. truth_root: name of root files containing MC truth info, should be put in the path under root_path;
    5. event_tree: tree name of [3]
    6. truth_tree: tree name of [4]
    7. cit_weight: some extra cut, not recommend to add in the this package, better to apply all the cuts before executing the program;
    8. pyroot_fit: True/true or False/false, only if shape_dep is set to be True/true, this part will be useful: using dedicated pyROOT Roofit program (tools/simul_fit.py) in this package to do FIT_EVT, this is a recommended way to do iteration since it will be very automatically, however, this will also put a pretty strict requirement of user's pyROOT knowledge, user can alse dismiss this function by setting this part to be False/false with manual_update to be False(false), and then update out put files (relative nsignal info) output in xs_new, and then execute 'python main.py' again, especially, if you want to use pyROOT Roofit program, this part must be set to be False/false;
    9. manual_update: manually update output results in xs_new (relative nsignal info)

4. [WIP]: Working in progress, any recommends will be welcomed sincerely!

## How to use

The aim of this repository is to provide a general package for users and the only thing users have to do is changing configure file (weight_isr.conf). However, due to the complexity of user defined function and plot style of canvas or pad, it is very hard to provide a general script. Therefore, the developer have to leave this space to users and the structure of this repository is based on python2. Fortunately, the things user has to change is not very much and easier to understand without much python knowledge.

> In main.py: line 74 - 135, defination of fit functions for input cross sections;

> In tools/fit_xs.py: line 26 - 34, defination of cross section formula;

> In tools/update.py: line 127 - 148, import module of user defined fit function (to get number of events, if the calculation of cross section is mc shape dependent) and usage of it, this section could be dismissed by setting [weight]: shape_dep = False and update the number of events manually and continue your work by setting [weight]: manual_update = False before updating and then True after updating;

> In tools/fill_xs.py: line 30 - 38, defination of cross section formula.
